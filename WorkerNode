package cs.tcd.ie;

import java.net.DatagramPacket;
import java.net.DatagramSocket;
import java.io.IOException;
import java.util.Timer;
import java.util.TimerTask;
import java.net.InetSocketAddress;


public class WorkerNode extends Node {
	static final int DST_PORT = 50001;
	static final int SRC_PORT = 60000;
	static final String DEFAULT_DST_NODE = "localhost";
	
	int portNum;
	String[] list;
	String search;
	int entriesProcessed, sectionsProcessed, workerID;
	long startTime;
	boolean running = true;
	Timer heartbeat, registration;
	InetSocketAddress dstAddress;
	/*
	 * @author: Shane Moloney
	 */
	WorkerNode(String dstHost, int dstPort, int srcPort, int id) {
		try {
			dstAddress = new InetSocketAddress(dstHost, dstPort);
			socket = new DatagramSocket(srcPort);
			listener.go();
			workerID = id;
		} catch (java.lang.Exception e) {
			e.printStackTrace();
		}
	}

	/**
	 * Receives WorkerPacket and sets local variables appropriately.
	 */
	public synchronized void onReceipt(DatagramPacket packet) 
	{
		try {
			PacketContent content = PacketContent.fromDatagramPacket(packet);
			if(content.getType() == PacketContent.WORKERPACKET)
			{
				list = ((WorkerPacket)content).getData();
				search = ((WorkerPacket)content).toString();
				heartbeat.cancel();
				heartbeat.purge();
				registration.cancel();
				registration.purge();
			}
			else if(content.getType() == PacketContent.STOPWORK)
			{
				running = ((StopWork)content).stopWork();
			}
			this.notify();
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
	
	
	/**
	 * Sends the registration packet and begins heartbeat timer.
	 */
	public void register()
	{
		DatagramPacket r = new Register(true, workerID).toDatagramPacket();
		r.setSocketAddress(dstAddress);
		try {
			socket.send(r);
		} catch (IOException e) {
			e.printStackTrace();
		}
		heartbeat = new Timer();
		heartbeat.schedule(new TimerTask()
		{
		@Override
		public void run()
		{
			DatagramPacket heartbeat = new Heartbeat(true, entriesProcessed, sectionsProcessed, workerID).toDatagramPacket();
			heartbeat.setSocketAddress(dstAddress);
			try {
				socket.send(heartbeat);
			} catch (IOException e) {
				e.printStackTrace();
			}
		}
		}, 1500, 1500);

		registration = new Timer();
		registration.schedule(new TimerTask()
		{
		@Override
		public void run()
		{
			DatagramPacket r = new Register(true, workerID).toDatagramPacket();
			r.setSocketAddress(dstAddress);
			try {
				socket.send(r);
			} catch (IOException e) {
				e.printStackTrace();
			}
		}
		}, 1000, 1000);
	}

	public synchronized void start() throws Exception 
	{
		register();
		list = new String[1];
		list[0] = "0";
		while(running)
		{
			startTime = System.nanoTime();
			entriesProcessed = 0;
			for(int i = 0; i < list.length; i++)
			{
				if(list[i].equals(search))
				{
					DatagramPacket result = new ResultPacket(i, System.nanoTime()-startTime, list.length, workerID).toDatagramPacket();
					result.setSocketAddress(dstAddress);
					socket.send(result);
					break;
				}
				entriesProcessed++;
			}
			sectionsProcessed++;
			heartbeat.cancel();
			heartbeat.purge();
			register();
			this.wait();
			
		}
		registration.cancel();
		registration.purge();
		
	}

	/*
	 * 
	 */
	public static void main(String[] args) {
		try {
			WorkerNode WorkerNodes[] = new WorkerNode[10];

			for(int i = 0; i < 5; i ++)
			{
				WorkerNodes[i] = new WorkerNode(DEFAULT_DST_NODE, DST_PORT,  SRC_PORT + i, i);
				WorkerNodes[i].start();
			}
		} catch (java.lang.Exception e) {
			e.printStackTrace();
		}
	}
}

